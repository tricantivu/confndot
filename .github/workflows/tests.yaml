name: "Tests"

on: push

jobs:
  shellcheck:

    runs-on: ubuntu-22.04

    steps:
    - name: "Checkout repository"
      uses: actions/checkout@main

    - name: "Install ShellCheck"
      run: sudo apt-get install shellcheck

    - name: "Check anacron scripts"
      run: shopt -s globstar && shellcheck -S error -f gcc .local/etc/cron.*/*

    - name: "Check custom scripts"
      run: shellcheck -S error -f gcc .local/bin/*

    - name: "Check .bashrc"
      run: shellcheck -S error -f gcc -e SC2148 .bashrc

  config-validation:

    runs-on: ubuntu-22.04

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@main

      - name: "systemd user units"
        run: >
          sudo apt-get install duplicity

          [[ -d "${HOME}/.local/bin" ]] || mkdir -pv "${HOME}/.local/bin"

          cp -v .local/bin/* "${HOME}/.local/bin"

          [[ -d "${HOME}/.config/systemd/user" ]] || mkdir -pv "${HOME}/.config/systemd/user"

          files=( .config/systemd/user/* )

          for file in "${files[@]}"; do

              cp -v "${file}" "${HOME}/.config/systemd/user"

          done

          systemctl --user daemon-reload

          for unit in "${files[@]##*/}"; do

              if systemd-analyze --user verify -- "${unit}"; then
                  continue

              else
                  exit 1

              fi

          done

      - name: "rofi"
        run: >
          sudo apt-get install rofi

          # Prevents unexisting file errors
          mkdir -pv .local/share/rofi/themes
          : > .local/share/rofi/themes/spotlight-dark.rasi

          rofi -rasi-validate .config/rofi/config.rasi
